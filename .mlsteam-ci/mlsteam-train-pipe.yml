format: v0.1
name: Yolov9 Setup & Training
vars:
  - name: base_model
    type: string
    label: Base Model
    default: lmsys/vicuna-7b-v1.3

  - name: data_folder
    type: folder
    label: Model Folder
    default: coco

  - name: train_epoch
    type: string
    label: Training Epoch
    default: '1'

  - name: train_batchsize
    type: string
    label: Batch Size Per Device
    default: '1'

  - name: output_name
    type: string
    label: Output Name
    default: vicuna-7b-dummy-cuda
    
  - name: model_max_length
    type: string
    label: Model Max Length
    default: '1024'

steps:
  - name: checkout code
    type: checkout
    needs: null
    dvc: no
    location: .

  - name: check data
    type: docker_run
    needs: pre
    flavor: micro
    image: p9ebc297/yolov9-train:v1
    run: |
      apt install -y tree &&  tree ./ && cd src && \
        test -e ${data_path}

  - name: Install required packages and train
    type: docker_run
    needs: pre
    image: p9ebc297/yolov9-train:v1
    flavor: medium
    folders:
      - ${data_folder}:/mlsteam/data/Coco
    run: |
      # cd src && pip install mlflow  &&  ls -a /usr/local/lib/python3.9/dist-packages
      export WANDB_DISABLED=true 
      # pip install mlflow bentoml
      pip install -r requirements.txt
      pip uninstall -y opencv-python
      pip install opencv-python-headless==4.5.5.64
      python train.py --workers 1 --device 0 --batch-size 4 --epochs 1 --data data/coco.yaml \
          --img 640 --cfg models/detect/yolov9-c.yaml --weights 'yolov9-c-converted.pt' \
          --name yolov9-custom --hyp hyp.scratch-high.yaml \
          --min-items 0 --close-mosaic 15
