format: v0.1
name: Yolov9 Setup & Training
vars:
  - name: data_folder
    type: folder
    label: Data Folder
    default: coco128

  - name: base_model
    type: model_version
    label: Based Model
    default: 'yolov9-c:v1'

  - name: train_epoch
    type: string
    label: Training Epoch
    default: '10'

  - name: train_batchsize
    type: string
    label: Batch Size Per Device
    default: '8'

steps:
  - name: checkout code
    type: checkout
    needs: null
    dvc: no
    location: .

  - name: train
    type: docker_run
    needs:
      - checkout code
    image: "${MLSTEAM_PROJECT_UUID}/yolov9-train:v2"
    flavor: medium
    folders:
      - ${data_folder}:/mlsteam/data/${data_folder}
    run: |
      echo "${base_model.MOUNT_PATH}"
      echo "$pwd"
      python train_dual.py --workers 1 --device 0 --batch-size ${train_batchsize} --epochs ${train_epoch} --data data/${data_folder}.yaml \
          --img 640 --cfg models/detect/yolov9-c.yaml --weights ${base_model.MOUNT_PATH}/${MODEL_NAME.MODEL_NAME} \
          --name yolov9-c --hyp hyp.scratch-high.yaml \
          --min-items 0 --close-mosaic 15

  - name: evaluate
    type: docker_run
    needs:
      - train
    image: "${MLSTEAM_PROJECT_UUID}/yolov9-train:v2"
    flavor: medium
    folders:
      - ${data_folder}:/mlsteam/data/${data_folder}
    run: |
      RUN_NAME="yolov9-bs${train_batchsize}-ep${train_epoch}-ds${dta_folder}"
      MLFLOW_RUN_NAME=$RUN_NAME python val_dual.py --data data/${data_folder}.yaml --img 640 --batch 32 --conf 0.001\
            --iou 0.7 --device 0 --weights 'runs/train/yolov9-custom/weights/best.pt' \
            --name yolov9
